<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>错误处理 | Go 语言笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ce26c35c5c5403057ebddcb99965920a";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
    <meta name="description" content=" ">
    
    <link rel="preload" href="/assets/css/0.styles.77dfaa16.css" as="style"><link rel="preload" href="/assets/js/app.5bdc8025.js" as="script"><link rel="preload" href="/assets/js/2.9a822252.js" as="script"><link rel="preload" href="/assets/js/9.7c4bd076.js" as="script"><link rel="prefetch" href="/assets/js/10.8da66157.js"><link rel="prefetch" href="/assets/js/11.bd814098.js"><link rel="prefetch" href="/assets/js/12.414b18af.js"><link rel="prefetch" href="/assets/js/13.e21b8012.js"><link rel="prefetch" href="/assets/js/14.8a073efc.js"><link rel="prefetch" href="/assets/js/15.f2fabb86.js"><link rel="prefetch" href="/assets/js/3.6529368c.js"><link rel="prefetch" href="/assets/js/4.e05c873c.js"><link rel="prefetch" href="/assets/js/5.33233bc0.js"><link rel="prefetch" href="/assets/js/6.498ab014.js"><link rel="prefetch" href="/assets/js/7.11760ee6.js"><link rel="prefetch" href="/assets/js/8.94349a7b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.77dfaa16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Go 语言笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/advance/error.html" aria-current="page" class="active sidebar-link">错误处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advance/error.html#构造-error" class="sidebar-link">构造 error</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advance/error.html#errors-new" class="sidebar-link">errors.New()</a></li><li class="sidebar-sub-header"><a href="/advance/error.html#fmt-errorf" class="sidebar-link">fmt.Errorf()</a></li></ul></li><li class="sidebar-sub-header"><a href="/advance/error.html#panic-与-recover" class="sidebar-link">panic() 与 recover()</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/advance/error.html#panic" class="sidebar-link">panic()</a></li><li class="sidebar-sub-header"><a href="/advance/error.html#recover" class="sidebar-link">recover()</a></li></ul></li></ul></li><li><a href="/advance/concurrent.html" class="sidebar-link">并发</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实战</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h1> <h2 id="构造-error"><a href="#构造-error" class="header-anchor">#</a> 构造 error</h2> <p>在 go 语言中，有一个预定义的接口：<code>error</code>，该接口自带一个 <code>Error()</code> 方法，调用该方法会返回一个字符串。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> <span class="token builtin">error</span> <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用该方法，会返回当前错误的具体结果。一般有下面几种方式生成 error。</p> <ul><li><code>errors.New()</code></li> <li><code>fmt.Errorf()</code></li></ul> <h3 id="errors-new"><a href="#errors-new" class="header-anchor">#</a> errors.New()</h3> <p>调用 <code>errors.New()</code> 会返回一个 error 类型的结构体，该结构体内部会实现一个 <code>Error()</code> 方法， 调用该方法返回的结果为调用 <code>errors.New()</code> 方法时传入的内容。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 被除数为0，则构造一个 error 结构体</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;被除数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> result <span class="token operator">=</span> a <span class="token operator">/</span> b
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span> <span class="token comment">// error 类型数据的初始值为 nil，类似于 js 中的 null</span>
	<span class="token keyword">var</span> result <span class="token builtin">int</span>

	err<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 err 为 nil，说明运行正常</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算结果&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 err 不为 nil，说明运行出错</span>
    <span class="token comment">// 调用 error 结构体的 Error 方法，输出错误原因</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算出错&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，上面的代码中，由于调用 <code>divide</code> 除法方法时，由于传入的被除数为 0。经过判断，会抛出一个由 <code>errors.New</code> 构造的 <code>error</code> 类型的结构体。</p> <p>我们将调用 <code>error.Error()</code> 方法返回的结果输出到控制台，可以发现其返回的结果，就是传入 <code>New</code> 方法的值。</p> <p>执行结果如下：</p> <p><img src="https://file.shenfq.com/pic/20210427164350.png" alt=""></p> <h3 id="fmt-errorf"><a href="#fmt-errorf" class="header-anchor">#</a> fmt.Errorf()</h3> <p>通过 <code>fmt.Errorf()</code> 方法构造的 error 结构体，与调用  <code>errors.New()</code> 方法的结果类似。不同的是，<code>fmt.Errorf()</code> 方法会进行一次数据的格式化。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将参数进行一次格式化，格式化后的字符串放入 error 中</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;数据 %d 不合法&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> result <span class="token operator">=</span> a <span class="token operator">/</span> b
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> result
<span class="token punctuation">}</span>

err<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算出错&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>执行结果如下：</p> <p><img src="https://file.shenfq.com/pic/20210427165114.png" alt=""></p> <h2 id="panic-与-recover"><a href="#panic-与-recover" class="header-anchor">#</a> panic() 与 recover()</h2> <h3 id="panic"><a href="#panic" class="header-anchor">#</a> panic()</h3> <p><code>panic()</code> 相当于主动停止程序运行，调用时 <code>panic()</code> 时，需要传入中断原因。调用后，会在控制台输出中断原因，以及中断时的调用堆栈。我们可以改造一下之前的代码：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果程序出错，直接停止运行</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;被除数不能为0&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> result <span class="token operator">=</span> a <span class="token operator">/</span> b
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  err<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算出错&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在运行到 <code>panic()</code> 处，程序直接中断，并在控制台打印出了中断原因。</p> <p><img src="https://file.shenfq.com/pic/20210427174701.png" alt=""></p> <p><code>panic()</code> 可以理解为，js 程序中的 <code>throw new Error()</code> 的操作。那么，在 go 中有没有办法终止 <code>panic()</code> ，也就是类似于 <code>try-catch</code> 的操作，让程序回到正常的运行逻辑中呢？</p> <h3 id="recover"><a href="#recover" class="header-anchor">#</a> recover()</h3> <p>在介绍 <code>recover()</code> 方法之前，还需要介绍一个 go 语言中的另一个关键字：<code>defer</code>。</p> <p><code>defer</code> 后的语句会在函数进行 return 操作之前调用，常用于<code>资源释放</code>、<code>错误捕获</code>、<code>日志输出</code>。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">getData</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">defer</span> 中断连接<span class="token punctuation">(</span><span class="token punctuation">)</span>
  db <span class="token operator">:=</span> 建立连接<span class="token punctuation">(</span>table<span class="token punctuation">)</span>
  data <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token keyword">select</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre></div><p><code>defer</code> 后的语句会被存储在一个类似于栈的数据结构内，在函数结束的时候，被定义的语句按顺序出栈，越后面定义的语句越先被调用。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
  <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;除数为&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
  <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;被除数为&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>

  result <span class="token operator">:=</span> a <span class="token operator">/</span> b
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算结果为&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码中，我们在函数开始运行的时候，先通过 <code>defer</code> 定义了两个输出语句，先输出<code>除数</code>，后输出<code>被除数</code>。</p> <p><img src="https://file.shenfq.com/pic/20210428114124.png" alt=""></p> <p>实际的运行结果是：</p> <ul><li>先输出计算结果；</li> <li>然后输出被除数；</li> <li>最后输出除数；</li></ul> <p>这和前面提到的，通过 <code>defer</code> 定义的语句会在函数结束的时候，按照出栈的方式进行执行，先定义的后执行。<code>defer</code> 除了会在函数结束的时候执行，出现异常的的时候也会先走 <code>defer</code> 的逻辑，也就是说，我们在调用了 <code>panic()</code> 方法后，程序中断过程中，也会先将 <code>defer</code> 内的语句运行一遍。</p> <p>这里我们重新定义之前的 <code>divide</code> 函数，在执行之前加上一个 <code>defer</code> 语句，<code>defer</code> 后面为一个自执行函数，该函数内会调用 <code>recover()</code> 方法。</p> <p><img src="https://file.shenfq.com/pic/20210428120154.png" alt=""></p> <p><code>recover()</code> 方法调用后，会捕获到当前的 <code>panic()</code> 抛出的异常，并进行返回，如果没有异常，则返回 <code>nil</code>。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
  <span class="token comment">// 中断之前，调用 defer 后定义的语句</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;捕获错误&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数运行被中断</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;被除数不能为0&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> a <span class="token operator">/</span> b
<span class="token punctuation">}</span>

result <span class="token operator">:=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;计算结果&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
</code></pre></div><p>上面的代码运行后，我们发现之前调用 <code>panic()</code> 中断的程序被恢复了，而且后面的计算结果也正常进行输出了。</p> <p><img src="https://file.shenfq.com/pic/20210428120544.png" alt=""></p> <p>这就有点类似于 <code>try-catch</code> 的逻辑了，只是 <code>recover</code> 需要放在 <code>defer</code> 关键词后的语句中，更像是 <code>catch</code> 和 <code>finally</code> 的结合。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">4/29/2021, 4:00:29 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/basic/struct.html" class="prev">
        结构体与方法
      </a></span> <span class="next"><a href="/advance/concurrent.html">
        并发
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5bdc8025.js" defer></script><script src="/assets/js/2.9a822252.js" defer></script><script src="/assets/js/9.7c4bd076.js" defer></script>
  </body>
</html>
